
REPORT ZDATA_MIGRATION_043. "BAPI and custom columns 2 extra

TYPES : BEGIN OF LTY_DATA,
         MATNR TYPE MATNR,
         MBRSH TYPE MBRSH,
         MTART TYPE MTART,
         MAKTX TYPE MAKTX,
         MEINS TYPE MEINS,
         ZZSYSTEM TYPE ZDESYSTEM, "custom
         ZZMTYP TYPE ZDEMTYP,"custom
         END OF LTY_DATA.

DATA : LT_DATA TYPE TABLE OF LTY_DATA.
DATA : LS_DATA TYPE LTY_DATA.
DATA : LV_FILE TYPE STRING.
DATA : LT_BDCDATA TYPE TABLE OF BDCDATA.
DATA : LS_BDCDATA TYPE BDCDATA.
DATA : LT_MESTAB TYPE TABLE OF BDCMSGCOLL.
DATA : LS_MESTAB TYPE BDCMSGCOLL.
DATA : LV_MESSAGE TYPE STRING.
DATA : LS_HEADDATA TYPE BAPIMATHEAD .
DATA : LS_CLIENTDATA TYPE BAPI_MARA .
DATA : LS_CLIENTDATAX TYPE BAPI_MARAX .
DATA : LT_DESC TYPE TABLE OF BAPI_MAKT .
DATA : LS_DESC TYPE  BAPI_MAKT .
DATA : LS_RETURN TYPE  BAPIRET2 .
DATA : LT_RETURN TYPE TABLE OF  BAPIRET2 .
DATA : LS_TE_MARA TYPE  BAPI_TE_MARA ."FOR CUSTOM
DATA : LS_TE_MARAX TYPE  BAPI_TE_MARAX ."FOR CUSTOM
DATA : LT_EXTENSIONIN TYPE TABLE OF BAPIPAREX ."FOR CUSTOM
DATA : LS_EXTENSIONIN TYPE BAPIPAREX ."FOR CUSTOM
DATA : LT_EXTENSIONINX TYPE TABLE OF BAPIPAREXX ."FOR CUSTOM
DATA : LS_EXTENSIONINX TYPE  BAPIPAREXX ."FOR CUSTOM


PARAMETERS : P_FILE TYPE LOCALFILE.

AT SELECTION-SCREEN ON VALUE-REQUEST FOR P_FILE.

  CALL FUNCTION 'F4_FILENAME'
    EXPORTING
      PROGRAM_NAME  = SYST-CPROG
      DYNPRO_NUMBER = SYST-DYNNR
      FIELD_NAME    = ' '
    IMPORTING
      FILE_NAME     = P_FILE.


START-OF-SELECTION.

  LV_FILE = P_FILE. "type casting

  CALL FUNCTION 'GUI_UPLOAD'
    EXPORTING
      FILENAME                = LV_FILE
*     FILETYPE                = 'ASC'
      HAS_FIELD_SEPARATOR     = 'X'
*     HEADER_LENGTH           = 0
*     READ_BY_LINE            = 'X'
*     DAT_MODE                = ' '
*     CODEPAGE                = ' '
*     IGNORE_CERR             = ABAP_TRUE
*     REPLACEMENT             = '#'
*     CHECK_BOM               = ' '
*     VIRUS_SCAN_PROFILE      =
*     NO_AUTH_CHECK           = ' '
*     I_X                     =
*      IMPORTING
*     FILELENGTH              =
*     HEADER                  =
    TABLES
      DATA_TAB                = LT_DATA
*      CHANGING
*     ISSCANPERFORMED         = ' '
    EXCEPTIONS
      FILE_OPEN_ERROR         = 1
      FILE_READ_ERROR         = 2
      NO_BATCH                = 3
      GUI_REFUSE_FILETRANSFER = 4
      INVALID_TYPE            = 5
      NO_AUTHORITY            = 6
      UNKNOWN_ERROR           = 7
      BAD_DATA_FORMAT         = 8
      HEADER_NOT_ALLOWED      = 9
      SEPARATOR_NOT_ALLOWED   = 10
      HEADER_TOO_LONG         = 11
      UNKNOWN_DP_ERROR        = 12
      ACCESS_DENIED           = 13
      DP_OUT_OF_MEMORY        = 14
      DISK_FULL               = 15
      DP_TIMEOUT              = 16
      OTHERS                  = 17.
  IF SY-SUBRC <> 0.
* Implement suitable error handling here
  ENDIF.

  LOOP AT LT_DATA INTO LS_DATA.
    LS_HEADDATA-MATERIAL = LS_DATA-MATNR.
    LS_HEADDATA-IND_SECTOR = LS_DATA-MBRSH.
    LS_HEADDATA-MATL_TYPE = LS_DATA-MTART.
    LS_HEADDATA-BASIC_VIEW = 'X'.
    LS_CLIENTDATA-BASE_UOM = LS_DATA-MEINS.
    LS_CLIENTDATAX-BASE_UOM = 'X'.
    LS_DESC-LANGU = SY-LANGU.
    LS_DESC-MATL_DESC = LS_DATA-MAKTX.
    APPEND LS_DESC TO LT_DESC.
    CLEAR LS_DESC.

*MARA EXTENSION
    LS_TE_MARA-MATERIAL = LS_DATA-MATNR.
    LS_TE_MARA-ZZSYSTEM = LS_DATA-ZZSYSTEM.
    LS_TE_MARA-ZZMTYP = LS_DATA-ZZMTYP.

    LS_TE_MARAX-MATERIAL = LS_DATA-MATNR.
    LS_TE_MARAX-ZZSYSTEM = 'X'.
    LS_TE_MARAX-ZZMTYP = 'X'.

    LS_EXTENSIONIN-STRUCTURE = 'BAPI_TE_MARA'." check in bapi ext FM
    LS_EXTENSIONIN-VALUEPART1 = LS_TE_MARA.
    APPEND LS_EXTENSIONIN TO LT_EXTENSIONIN.
    CLEAR : LS_EXTENSIONIN.

    LS_EXTENSIONINX-STRUCTURE = 'BAPI_TE_MARAX'.
    LS_EXTENSIONINX-VALUEPART1 = LS_TE_MARAX.
    APPEND LS_EXTENSIONINX TO LT_EXTENSIONINX.
    CLEAR : LS_EXTENSIONINX.

    CALL FUNCTION 'BAPI_MATERIAL_SAVEDATA'
      EXPORTING
        HEADDATA            = LS_HEADDATA
        CLIENTDATA          = LS_CLIENTDATA
        CLIENTDATAX         = LS_CLIENTDATAX
*       PLANTDATA           =
*       PLANTDATAX          =
*       FORECASTPARAMETERS  =
*       FORECASTPARAMETERSX =
*       PLANNINGDATA        =
*       PLANNINGDATAX       =
*       STORAGELOCATIONDATA =
*       STORAGELOCATIONDATAX       =
*       VALUATIONDATA       =
*       VALUATIONDATAX      =
*       WAREHOUSENUMBERDATA =
*       WAREHOUSENUMBERDATAX       =
*       SALESDATA           =
*       SALESDATAX          =
*       STORAGETYPEDATA     =
*       STORAGETYPEDATAX    =
*       FLAG_ONLINE         = ' '
*       FLAG_CAD_CALL       = ' '
*       NO_DEQUEUE          = ' '
*       NO_ROLLBACK_WORK    = ' '
      IMPORTING
        RETURN              = LS_RETURN
      TABLES
        MATERIALDESCRIPTION = LT_DESC
*       UNITSOFMEASURE      =
*       UNITSOFMEASUREX     =
*       INTERNATIONALARTNOS =
*       MATERIALLONGTEXT    =
*       TAXCLASSIFICATIONS  =
*       RETURNMESSAGES      =
*       PRTDATA             =
*       PRTDATAX            =
        EXTENSIONIN         = LT_EXTENSIONIN " for custom
        EXTENSIONINX        = LT_EXTENSIONINX. " for custom

    APPEND LS_RETURN TO LT_RETURN.
    CLEAR : LS_RETURN,LS_HEADDATA,LS_CLIENTDATA,LS_CLIENTDATAX,LS_TE_MARA,LS_TE_MARA.
    REFRESH : LT_DESC,LT_EXTENSIONIN,LT_EXTENSIONINX.
  ENDLOOP.

  LOOP AT LT_RETURN INTO LS_RETURN.
    WRITE : LS_RETURN-MESSAGE.
  ENDLOOP.
